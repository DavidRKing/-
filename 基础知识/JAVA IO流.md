#### JAVA IO流

#####   面向IO流:

​    文件，磁盘，网络   ---------->程序  （流，数据，单向）

​    文件，磁盘，网络到程序 (输入流)

​    程序到文件，磁盘，网络(输出流)  

#####  NIO面向缓冲区

​    文件，磁盘，网络   ---------->程序  （建立通道,铁路，远地点和目标地点连接。实际不运输，无法传输数据）

​                                                                缓冲区 相当于火车,用于传输数据.双向的)

| IO     | NIO               |
| ------ | ----------------- |
| 面向流 | 面向缓冲区        |
| 阻塞IO | 非阻塞IO          |
|        | 选择器(Selectors) |



##### 通道和缓冲区的区别

​        Java NIO系统的核心在于：通道(Channel)和缓冲区(Buffer)。通道表示打开到IO设备(例如：文件，套接字)的连接。若需要使用NIO系统，需要获取用于连接IO设备的通道以及用于容纳数据的缓冲区。然后操作缓冲区，对数据进行处理。简而言之，Channel负责传输，Buffer负责存储 (火车道， 火车)



##### 直接缓冲区





##### 非直接缓冲区

​                                   OS                                   JVM

​     物理磁盘            内核地址空间                 用户地址空间                       应用程序

​                    read()->         缓存        copy()-->          缓存   read()--> 

​                   <-write()                       <-copy()              <--write()



​                                            （直接缓冲区）

​       物理内存映射文件(省了 copy过程，提高了效率，资源消耗比较大,不容易控制)



##### 通道

​    通道(Channel):由java.nio.channels包定义的。Channel表示IO源于目标打开的连接。

​    Channel类似于传统的流。只不过Channel本身不能直接访问数据，Channel只能与Buffer进行交互。



早期，应用程序调用操作系统底层的IO接口来进行文件读取。

IO操作都有CPU来执行。这样会大量占用CPU资源。

CPU---->IO接口------>            内核地址空间                 用户地址空间                       应用程序

​                         <------    



后来又了DMA （IO流，应用程序调用IO接口，DMA对CPU进行申请，通过，由DMA来执行IO操作。DMA总线，大量IO操作，会造成DMA总线冲突。）

 CPU   IO接口------>            内核地址空间                 用户地址空间                       应用程序

​            |

​         DMA                  <------    



通道与原来DMA的区别

CPU   IO接口------>            内核地址空间                 用户地址空间                       应用程序

​            |

​         通道Channel（完全独立的处理器，单独处理IO操作,与CPU彻底断绝关系）

##### 分散（Scattering Reads） 和 聚集（Gather）

分散读取是指从Channel中读取的数据“分散”到多个buffer中

channel ---> buffer0  buffer1  buffer2

注意：按照缓冲区的顺序，从channel中读取的数据一次将buffer填满（buffer0写满后，buffer1，再buffer2）

聚集写入：是指多个Buffer中的数据“聚集”到Channel中

buffer0  buffer 1 buffer 2 ------------->channel

注意：按照缓冲区的顺序，写入position和limit之间的数据到Channel。



##### NIO的非阻塞式网络通信

​                        read(),write()。服务端会等待客户端处在阻塞状态

​    所以，以前，服务端为每一个客户端发过来的请求，建立一个线程，去独立的处理任务，某一个线程阻塞，其他线程还可以工作。充分利用了CPU资源.

   Client           -------------------->            Server

​                                                          用户地址空间

​                                                          内核地址空间



非阻塞IO



Client           -------------------->            Server

​                    Selector（选择器）    用户地址空间

​                                                          内核地址空间

客户端通道都会注册到Selector中，Selector会实时的监控这些通道的IO状态，一旦IO准备就绪。selector才会调用Server端，分配一个或多个线程，来处理IO操作。

客户端如果没有准备就绪，服务端该干啥干啥。更能进一步利用CPU资源

















​      





























































